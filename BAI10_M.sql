CREATE TABLE PHONG
(
	MAPH VARCHAR(10) PRIMARY KEY,
	LOAIPH VARCHAR(10),
	DT INT,
	GIAPH FLOAT
)
GO
CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(10) PRIMARY KEY, 
	TENKH VARCHAR(30),
	DIENTHOAI VARCHAR(10),
	DIACHI VARCHAR(10)
)
GO
CREATE TABLE THUEPHONG
(
	MAHD VARCHAR(10) PRIMARY KEY,
	MAKH VARCHAR(10),
	NGAYBD DATE,
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)
GO
CREATE TABLE CTTHUEPHONG
(
	MAHD VARCHAR(10),
	MAPH VARCHAR(10),
	NGAYKT DATE,
	THANHTIEN MONEY,
	PRIMARY KEY (MAHD,MAPH),
	FOREIGN KEY (MAHD) REFERENCES THUEPHONG(MAHD),
	FOREIGN KEY (MAPH) REFERENCES PHONG(MAPH)
)

INSERT INTO PHONG VALUES
('PH01','A',50,20),
('PH02','B',60,30),
('PH03','B',40,40),
('PH04','A',10,50),
('PH05','C',20,60),
('PH06','B',30,70)

INSERT INTO KHACHHANG VALUES
('KH01','TRAN MINH GIAP','0396434223','THAI BINH'),
('KH02','VU LAI NGOC TRINH','0391509204','SAI GON'),
('KH03','PHAM THI THUY','0365936122','THANH HOA'),
('KH04','DANG YEN NHI','0393101525','THAI BINH'),
('KH05','DINH NGOC THAO MY','0391977333','HA NOI'),
('KH06','TRAN VAN BINH','0394530944','THAI BINH')

INSERT INTO THUEPHONG VALUES
('HD01','KH01','2023-11-05'),
('HD02','KH01','2023-10-22'),
('HD03','KH02','2023-07-08'),
('HD04','KH03','2023-01-16'),
('HD05','KH04','2022-12-15'),
('HD06','KH05','2023-09-07')

INSERT INTO CTTHUEPHONG VALUES
('HD01','PH01','2023-12-12',100),
('HD01','PH02','2024-11-17',110),
('HD02','PH03','2024-07-28',120),
('HD03','PH02','2024-03-13',130),
('HD04','PH03','2024-05-21',140),
('HD05','PH04','2024-11-10',150),
('HD06','PH05','2024-04-29',160)
SELECT KHACHHANG.TENKH FROM KHACHHANG, THUEPHONG
WHERE KHACHHANG.MAKH = THUEPHONG.MAKH AND MAHD = 'HD01'
CREATE DEFAULT DF1
AS GETDATE()
EXEC sp_bindefault 'DF1', 'THUEPHONG.NGAYBD'
CREATE PROC PR1 @TIM CHAR(30)
AS SELECT * FROM PHONG,CTTHUEPHONG WHERE PHONG.MAPH = CTTHUEPHONG.MAPH AND CTTHUEPHONG.MAHD = @TIM
EXEC PR1 'HD01'
CREATE TRIGGER TG1 ON CTTHUEPHONG
FOR UPDATE
AS
BEGIN
 UPDATE CTTHUEPHONG
 SET THANHTIEN = DATEDIFF(DAY,NGAYBD,NGAYKT)*GIAPH FROM PHONG,THUEPHONG,CTTHUEPHONG
 WHERE THUEPHONG.MAHD = CTTHUEPHONG.MAHD AND CTTHUEPHONG.MAPH = PHONG.MAPH
END
BACKUP DATABASE BAI10_M TO DISK = 'E:/tep1.bak'
ALTER TRIGGER TG2 ON PHONG
FOR INSERT
AS
BEGIN
 IF ((SELECT inserted.DT FROM inserted) < 0 )
 BEGIN
  PRINT 'DT PHAI LON HON 0'
  ROLLBACK TRAN
 END
END