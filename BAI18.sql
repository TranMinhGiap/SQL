CREATE TABLE DIADIEM(
 MADD CHAR(30) PRIMARY KEY,
 TENDD CHAR(30),
 THANHPHO CHAR(30),
 )
CREATE TABLE CHUYENDI(
 MACD CHAR(30) PRIMARY KEY,
 TENCD CHAR(30),
 NGAYBD DATE,
 NGAYKT DATE,
 SOKHACHDK INT,)
CREATE TABLE CTCHUYENDI(
 MACD CHAR(30) REFERENCES CHUYENDI(MACD),
 MADD CHAR(30) REFERENCES DIADIEM(MADD),
 SONGAYLUU INT,)
 INSERT INTO CHUYENDI VALUES
('CD01','DULICH1','2023/08/09','2023/09/12',50),
('CD02','DULICH2','2023/01/10','2023/04/05',40),
('CD03','DULICH3','2023/02/12','2023/05/09',70),
('CD04','DULICH4','2023/03/22','2023/06/22',35),
('CD05','DULICH5','2023/04/27','2023/07/30',15),
('CD06','DULICH6','2023/05/30','2023/10/15',60)

INSERT INTO DIADIEM VALUES
('DD01','NUI1','HALONG'),
('DD02','NUI2','THAIBINH'),
('DD03','NUI3','HANOI'),
('DD04','NUI4','THANHHOA'),
('DD05','NUI5','HAI PHONG'),
('DD06','NUI6','QUANG NINH'),
('DD07','NUI7','SAI GON')

INSERT INTO CTCHUYENDI VALUES
('CD01','DD01',1),
('CD01','DD03',2),
('CD01','DD05',3),
('CD02','DD02',4),
('CD02','DD04',5),
('CD03','DD07',6),
('CD03','DD06',7),
('CD04','DD02',8),
('CD04','DD06',9),
('CD05','DD07',10),
('CD05','DD03',11),
('CD05','DD05',12),
('CD06','DD01',13),
('CD06','DD03',14),
('CD06','DD05',15)
--TAO VIEW LUU TT CHUYEN DI DI QUA IT DD NHAT
CREATE VIEW V1
AS SELECT CHUYENDI.MACD,CHUYENDI.TENCD FROM CTCHUYENDI, CHUYENDI
WHERE CTCHUYENDI.MACD = CHUYENDI.MACD
GROUP BY CHUYENDI.MACD,CHUYENDI.TENCD
HAVING COUNT(*) <=ALL (SELECT (COUNT(*)) FROM CTCHUYENDI GROUP BY MACD)
SELECT * FROM V1
CREATE DEFAULT DF1
AS GETDATE()
EXEC sp_bindefault 'DF1','CHUYENDI.NGAYBD'
--TAO TT HTHI TT CAC CHUYEN CHUYEN DI CO TONG SO NGAY LUU LAI LON NHAT
CREATE PROC PR1
AS SELECT CHUYENDI.MACD, CHUYENDI.TENCD,SUM(SONGAYLUU) FROM CTCHUYENDI,CHUYENDI
WHERE CHUYENDI.MACD = CTCHUYENDI.MACD
GROUP BY CHUYENDI.MACD, CHUYENDI.TENCD
HAVING SUM(SONGAYLUU) >= ALL(SELECT SUM(SONGAYLUU) FROM CTCHUYENDI GROUP BY MACD)
EXEC PR1
CREATE TRIGGER TG1 ON CHUYENDI
FOR INSERT 
AS
 BEGIN
  IF ((SELECT NGAYKT FROM inserted) < GETDATE() OR (SELECT NGAYKT FROM inserted) > '2025-04-01' )
   BEGIN
    PRINT'LOI'
	ROLLBACK TRAN
   END
 END
