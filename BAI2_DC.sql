CREATE TABLE HANGHOA
(
	MAHANG VARCHAR(10) PRIMARY KEY,
	TENHANG VARCHAR(30),
	DONVITINH VARCHAR(10),
	SOLUONG INT
)
GO
CREATE TABLE HOADON
(
	MAHD VARCHAR(10) PRIMARY KEY,
	NGAYHD DATE,
	TIENBAN MONEY,
	GIAMGIA MONEY,
	THANHTOAN MONEY
)
GO
CREATE TABLE CTHOADON
(
	MAHD VARCHAR(10),
	MAHANG VARCHAR(10),
	SOLUONG INT,
	DONGIA MONEY,
	PRIMARY KEY (MAHD,MAHANG),
	FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	FOREIGN KEY (MAHANG) REFERENCES HANGHOA(MAHANG)
)
GO
INSERT INTO HANGHOA VALUES
('MH01','QUAN AO','BO',400),
('MH02','XE MAY','CAI',120),
('MH03','THIT','KG',200),
('MH04','BANH KEO','HOP',100),
('MH05','NUOC NGOT','THUNG',350),
('MH06','RAU VA HOA QUA','GIO',500)

INSERT INTO HOADON VALUES
('HD01','2023/09/15',900,10,890),
('HD02','2023/10/19',500,20,480),
('HD03','2023/10/14',750,100,650),
('HD04','2023/05/07',150,15,135),
('HD05','2023/04/06',90,30,60)
GO

INSERT INTO CTHOADON VALUES
('HD01','MH01',100,350),
('HD01','MH02',40,950),
('HD01','MH03',50,150),
('HD02','MH05',100,350),
('HD02','MH06',100,350),
('HD03','MH04',100,350),
('HD03','MH01',100,350),
('HD04','MH05',100,350),
('HD04','MH02',100,350),
('HD05','MH06',100,350)
GO

-- 2 HIEN THI THONG TIN MAT HANG CO SO LUONG > 20 DON VI TINH
SELECT * FROM HANGHOA
WHERE SOLUONG > 20

-- 3 TAO BO SUNG RANG BUOC DEFAULT CHO COT NGAYHD LA NGYA HIEN TAI
SELECT * INTO CHECK_HOADON FROM HOADON -- TAO BANG KHAC CHO DO ROI

SELECT * FROM CHECK_HOADON  -- XEM

ALTER TABLE CHECK_HOADON ADD PRIMARY KEY (MAHD) -- TAO KHOA CHINH CHO BANG PHU !

CREATE DEFAULT DF AS GETDATE()  -- TAO DEFAULT

EXEC sp_bindefault 'DF','CHECK_HOADON.NGAYHD'  -- RANG BUOC VAO COT NGAYHD CUA BANG CHECK_HOADON

EXEC sp_unbindefault 'CHECK_HOADON.NGAYHD'  -- XOA RANG BUOC

DROP DEFAULT DF  -- XOA DEFAULT

-- 4 TAO TRIGGER CAP NHAT LAI SO LUONG TRONG BANG HANG HOA MOI KHI HANG DUOC BAN !
CREATE TRIGGER TG1 ON CTHOADON 
FOR INSERT,DELETE,UPDATE
AS
	BEGIN
		UPDATE HANGHOA
		SET SOLUONG = HANGHOA.SOLUONG -(SELECT SUM(SOLUONG) FROM CTHOADON WHERE CTHOADON.MAHANG = inserted.MAHANG)
		FROM HANGHOA,CTHOADON,HOADON
		INNER JOIN inserted ON HOADON.MAHANG = inserted.MAHANG
	END

ALTER TABLE CTHOADON 
DISABLE TRIGGER TG1

DROP TRIGGER TG1

--


CREATE TRIGGER UpdateSoluongHang
ON CTHOADON
AFTER INSERT
AS
BEGIN
    UPDATE H
    SET Soluong = H.Soluong - I.Soluong
    FROM HANGHOA H
    INNER JOIN inserted AS I ON H.Mahang = I.Mahang;
END;
GO

ALTER TABLE CTHOADON 
DISABLE TRIGGER UpdateSoluongHang

DROP TRIGGER UpdateSoluongHang

