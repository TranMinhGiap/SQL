CREATE TABLE HANGHOA
(
	MAHANG VARCHAR(10) PRIMARY KEY,
	TENHANG VARCHAR(30),
	DONVITINH VARCHAR(10),
	SOLUONG INT
)
GO
CREATE TABLE HOADON
(
	MAHD VARCHAR(10) PRIMARY KEY,
	NGAYHD DATE,
	TIENBAN MONEY,
	GIAMGIA MONEY,
	THANHTOAN MONEY
)
GO
CREATE TABLE CTHOADON
(
	MAHD VARCHAR(10),
	MAHANG VARCHAR(10),
	SOLUONG INT,
	DONGIA MONEY,
	PRIMARY KEY (MAHD,MAHANG),
	FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	FOREIGN KEY (MAHANG) REFERENCES HANGHOA(MAHANG)
)
GO
INSERT INTO HANGHOA VALUES
('MH01','QUAN AO','BO',400),
('MH02','XE MAY','CAI',120),
('MH03','THIT','KG',200),
('MH04','BANH KEO','HOP',100),
('MH05','NUOC NGOT','THUNG',350),
('MH06','RAU VA HOA QUA','GIO',500)

INSERT INTO HOADON VALUES
('HD01','2023/09/15',900,10,890),
('HD02','2023/10/19',500,20,480),
('HD03','2023/10/14',750,100,650),
('HD04','2023/05/07',150,15,135),
('HD05','2023/04/06',90,30,60)
GO

INSERT INTO CTHOADON VALUES
('HD01','MH01',100,350),
('HD01','MH02',40,950),
('HD01','MH03',50,150),
('HD02','MH05',100,350),
('HD02','MH06',100,350),
('HD03','MH04',100,350),
('HD03','MH01',100,350),
('HD04','MH05',100,350),
('HD04','MH02',100,350),
('HD05','MH06',100,350)
GO

-- 2 HIEN THI THONG TIN CAC MAT HANG CO SO LUONG > 20 DON VI TINH
SELECT * FROM HANGHOA
WHERE SOLUONG > '100'

-- 3 TAO BO SUNG RANG BUOC DEFAULT CHO COT NGAY HD LA NGAY HIEN TAI 
SELECT * INTO HOADON_1 FROM HOADON  -- TAO BANG MOI 
SELECT * FROM HOADON_1

ALTER TABLE HOADON_1
ADD PRIMARY KEY (MAHD)

CREATE DEFAULT DF1 AS GETDATE()  -- TAO DEFAULT

EXEC sp_bindefault 'DF1','HOADON_1.NGAYHD'  -- RANG BUOC VAO COT

EXEC sp_unbindefault 'HOADON_1.NGAYHD'  -- HUY RANG BUOC

DROP DEFAULT DF1

-- 4 TAO TRIGGER CAP NHAT LAI SO LUONG HANG HOA MOI KHI DUOC BAN 
CREATE TRIGGER TG_1
ON CTHOADON
AFTER INSERT,DELETE,UPDATE
AS
BEGIN
    DECLARE @MAHANG VARCHAR(10)
    DECLARE @SOLUONG INT
    SELECT @MAHANG = MAHANG, @SOLUONG = SOLUONG
    FROM inserted
    UPDATE HANGHOA
    SET SOLUONG = SOLUONG - @SOLUONG
    WHERE MAHANG = @MAHANG
END

DROP TRIGGER TG_1

CREATE TRIGGER TG_2 ON CTHOADON
FOR UPDATE
AS 
	BEGIN
		UPDATE HANGHOA
		SET Soluong = H.Soluong - i.Soluong
		FROM HANGHOA h
		INNER JOIN inserted i ON h.Mahang = i.Mahang;
END;

DISABLE TRIGGER TG_2 ON CTHOADON  -- HAY ALTER TABLE BANG .....
GO 
DROP TRIGGER TG_2
-- 5 HIEN THI SO TIEN THANH TOAN CUA HOA DON CO MA HD01
SELECT THANHTOAN FROM HOADON
WHERE MAHD = 'HD01'

-- 6 TAO BO SUNG RANG BUOC DEFAULT CHO COT TIEN BAN BANG 0
CREATE DEFAULT DF2 AS 0  -- TAO DEFAULT

EXEC sp_bindefault 'DF2','HOADON_1.TIENBAN'  -- RANG BUOC VAO COT

EXEC sp_unbindefault 'HOADON_1.TIENBAN'  --HUY RANG BUOC

DROP DEFAULT DF2  -- XOA DEFAULT

-- 7 TAO TRIGGER CAP NHAT LAI TIEN BAN CUA MOI HOA DON KHI THEM MAT HANG VAO BANG CTHOADON
-- TIEN BAN = SUM(SOLUONG * DONGIA)
CREATE TRIGGER TG_3 ON CTHOADON
FOR INSERT,DELETE,UPDATE
AS
	BEGIN
		UPDATE HOADON
		SET TIENBAN = (SELECT SUM(SOLUONG * DONGIA)
		FROM CTHOADON
		WHERE HOADON.MAHD = CTHOADON.MAHD
		GROUP BY MAHD )
	END

DROP TRIGGER TG_3

-- 8 HIEN THI THONG TIN CAC HOA DON CO SO TIEN THANH TOAN LON NHAT 
SELECT * FROM HOADON
WHERE THANHTOAN = (SELECT MAX(THANHTOAN) FROM HOADON)

SELECT * FROM HOADON
WHERE THANHTOAN >= ALL(SELECT THANHTOAN FROM HOADON)

-- 9 TAO RULE CHO COT SOLUONG CUA BANG HANG HOA NHAN GIA TRI LON HON 0
SELECT * INTO HANGHOA_1 FROM HANGHOA  -- TAO BANG MOI

ALTER TABLE HANGHOA_1 ADD PRIMARY KEY (MAHANG)  -- THEM KHOA CHINH

CREATE RULE R_1 AS @CHECK > 0  -- TAO RULE

EXEC sp_bindrule 'R_1','HANGHOA_1.SOLUONG'  -- RANG BUOC VAO COT

EXEC sp_unbindrule 'HANGHOA_1.SOLUONG'  -- HUY RANG BUOC

DROP RULE R_1

-- 10 
CREATE TRIGGER TG4 ON HOADON
FOR INSERT,UPDATE
AS
UPDATE HOADON
SET THANHTOAN = THANHTOAN - THANHTOAN*GIAMGIA
-- 11 HIEN THI THONG TIN CUA CAC MAT HANG CO DON VI TINH LA BO 
SELECT * FROM HANGHOA
WHERE DONVITINH = 'BO'

-- 12 TAO BO SUNG RANG BUOC RULE CHI NHAN GIA TRI CHIEC BO 
CREATE RULE R_2 AS @CHECK IN ('CHIEC','BO') -- @CHECK = 'CHIEC' OR @CHECK = 'BO'

EXEC sp_bindrule 'R_2','HANGHOA.DONVITINH'  -- RANG BUOC VAO COT

EXEC sp_unbindrule 'HANGHOA.DONVITINH'  -- HUY RANG BUOC

DROP RULE R_2

-- 13 

-- 14 HIEN THI MA HANG SO LUONG HANG DUOC BAN BOI HOA DON CO MA LA HD01
SELECT * FROM CTHOADON WHERE MAHD = 'HD01'

--  15 TAO VIEW LUU THONG TIN CUA CAC MAT HANG CHUA DUOC BAN TAI CUA HANG 
CREATE VIEW VIEW_1 AS   -- MA HANG NAM TRONG BANG HANG HOA MA KHONG NAM TRONG BANG CTHOADON
SELECT * FROM HANGHOA
WHERE MAHANG NOT IN (SELECT MAHANG FROM CTHOADON)

SELECT * FROM HANGHOA

SELECT * FROM CTHOADON

SELECT * FROM VIEW_1

DROP VIEW VIEW_1

-- 16 

-- 17 HIEN THI TIEN BAN CUA HOA DON CO MA HD01
SELECT TIENBAN FROM HOADON
WHERE MAHD = 'HD01'

-- 18 HIEN THI THONG TIN MAT HANG DUOC BAN VOI SO LUONG IT NHAT 
-- THONG TIN GOM MAHANG TENHANG VA TONG SO LUONG DC BAN
SELECT HANGHOA.MAHANG,TENHANG,SUM(CTHOADON.SOLUONG) AS TOTAL
FROM CTHOADON,HANGHOA
WHERE HANGHOA.MAHANG = CTHOADON.MAHANG
GROUP BY HANGHOA.MAHANG,TENHANG
HAVING SUM(CTHOADON.SOLUONG) <= ALL(SELECT SUM(SOLUONG) 
							FROM CTHOADON
							GROUP BY MAHANG)

SELECT * FROM CTHOADON,HANGHOA
WHERE HANGHOA.MAHANG = CTHOADON.MAHANG

-- 19 TAO THU TUC HIEN THI THONG TIN HANG HOA KHI BIET MA DUNG 
CREATE PROC PR_1 @CHECK CHAR(10)
AS
	( SELECT * FROM HANGHOA
		WHERE MAHANG = @CHECK )

EXEC PR_1 'MH02'

DROP PROC PR_1 -- XOA THU TUC 

-- 20 HIEN THI MA HOA DON DUOC THIET LAP NAM 2023
SELECT * FROM HOADON
WHERE YEAR(NGAYHD) = 2023

-- 21 HIEN THI THONG TIN MAT HANG DUOC BAN VOI SO LUONG NHIEU NHAT 
-- THONG TIN GOM MAHANG TENHANG VA TONG SO LUONG DC BAN	

SELECT HANGHOA.MAHANG,TENHANG,SUM(CTHOADON.SOLUONG) AS TOTAL 
FROM CTHOADON,HANGHOA
WHERE CTHOADON.MAHANG = HANGHOA.MAHANG
GROUP BY HANGHOA.MAHANG,TENHANG
HAVING SUM(CTHOADON.SOLUONG) >= ALL( SELECT SUM(SOLUONG)
										FROM CTHOADON
										GROUP BY MAHANG )
-- 22 TAO THU TUC HIEN THI THONG TIN CUA HOA DON KHI BIET MA HOA DON 
CREATE PROC PR_2 @CHECK CHAR(10)
AS
	(SELECT * FROM HOADON
	WHERE MAHD = @CHECK)

EXEC PR_2 'HD01'

-- 23 VIET LENH BACK UP SANG O DIA KHAC