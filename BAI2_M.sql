CREATE TABLE SINHVIEN
(
	MASV VARCHAR(10) PRIMARY KEY,
	TENSV VARCHAR(30),
	NGAYSINH DATE,
	GIOITINH VARCHAR(10),
	DIACHI VARCHAR(10),
	MALOP VARCHAR(10)
)
GO
CREATE TABLE GIANGVIEN
(
	MAGV VARCHAR(10) PRIMARY KEY,
	TENGV VARCHAR(30),
	DIACHI VARCHAR(10)
)
GO
CREATE TABLE DETAI
(
	MADT VARCHAR(10) PRIMARY KEY,
	TENDT VARCHAR(30),
	SOSV INT,
	MAGV VARCHAR(10) REFERENCES GIANGVIEN(MAGV)
)
GO
CREATE TABLE DIEMSV
(
	MASV VARCHAR(10) REFERENCES SINHVIEN(MASV),
	MADT VARCHAR(10) REFERENCES DETAI(MADT),
	LOAIDIEM VARCHAR(10),
	DIEM FLOAT,
	PRIMARY KEY (MASV,MADT,LOAIDIEM),
)

INSERT INTO SINHVIEN VALUES
('SV01','DANG YEN NHI','2004/10/14','NU','THAI BINH','L01'),
('SV02','TRAN MINH GIAP','2004/09/15','NAM','THAI BINH','L01'),
('SV03','PHAM THI THUY','2004/07/22','NU','THANH HOA','L02'),
('SV04','VU LAI NGOC TRINH','2004/05/25','NU','SAI GON','L03'),
('SV05','DINH NGOC THAO MY','2005/08/09','NU','NGHE AN','L03'),
('SV06','PHAM HONG NGA','2004/12/28','NU','JAPAN','L04'),
('SV07','TRAN VAN BINH','1960/11/15','NAM','THAI BINH','L05')

INSERT INTO GIANGVIEN VALUES
('GV01','BUI KIM TUYEN','THAI BINH'),
('GV02','NGUYEN PHAN CHIEN','THANH HOA'),
('GV03','TRAN KIM LONG','SOC SON'),
('GV04','VU HONG NHUNG','HOANG DIEU'),
('GV05','NGUYEN THI NGUYET','VU DONG'),
('GV06','PHAM THANH THUY','THAI BINH'),
('GV07','NGUYEN MINH ANH','HA NOI')

INSERT INTO DETAI VALUES
('DT01','LUAT GIAO THONG',5,'GV01'),
('DT02','PHAT TRIEN TRI TUE NHAN TAO',6,'GV01'),
('DT03','GIAI TOAN QUA MANG',7,'GV02'),
('DT04','VE BAO TUONG',8,'GV03'),
('DT05','TIM HIEU VAN HOA VIET NAM',9,'GV04'),
('DT06','AN TOAN THUC PHAM',4,'GV05'),
('DT07','BAO VE MOI TRUNG',3,'GV06')

INSERT INTO DIEMSV VALUES
('SV01','DT01','A',9.0),
('SV01','DT02','B',7.0),
('SV01','DT03','A',9.1),
('SV02','DT01','B',7.7),
('SV03','DT04','C',5.0),
('SV03','DT05','B',7.4),
('SV04','DT06','B',7.1),
('SV05','DT03','A',8.8),
('SV06','DT07','C',5.7),
('SV07','DT05','B',7.75)

-- 2 ) HIEN THI THONG TIN GIANG VIEN HUONG DAN DE TAI CO MA DT03
SELECT GIANGVIEN.MAGV,TENGV FROM DETAI,GIANGVIEN
WHERE DETAI.MAGV = GIANGVIEN.MAGV
AND MADT = 'DT01'

-- 3 ) TAO BO SUNG RANG BUOC RULE CHO COT GIOI TINH CHO NHAN GIA TRI NAM HOAC NU
CREATE RULE R1 AS @CHECK = 'NAM' OR @CHECK = 'NU'

---- CREATE RULE R1 AS @CHECK IN ('NAM','NU')
EXEC sp_bindrule 'R1','SINHVIEN.GIOITINH'  -- RANG BUOC VAO COT
EXEC sp_unbindrule 'SINHVIEN.GIOITINH'  -- HUY RANG BUOC
DROP RULE R1 -- XOA RULE

-- 4 ) TAO THU TUC HIEN THI THONG TIN CUA CAC SINH VIEN KHI BIET TEN GIANG VIEN HUONG DAN
CREATE PROC PR1 @CHECK VARCHAR(30) AS
SELECT DISTINCT SINHVIEN.MASV,TENSV FROM DETAI,DIEMSV,GIANGVIEN,SINHVIEN
WHERE DIEMSV.MADT = DETAI.MADT
AND DETAI.MAGV = GIANGVIEN.MAGV
AND DIEMSV.MASV = SINHVIEN.MASV
AND TENGV = @CHECK

EXEC PR1 'PHAM THANH THUY'

-- 5 ) TAO TRIGGER CAP NHAT LAI SO SINH VIEN THAM GIA DE TAI TRONG BANG DETAI KHI CO SU THAY DOI SINH VIEN
-- TRONG BANG DIEMSV BIET SO SINH VIEN CUA 1 DE TAI BANG TONG SO SINH VIEN TRONG BANG DIEM VOI MOI DE TAI
CREATE TRIGGER TG1 ON DIEMSV
AFTER INSERT,UPDATE,DELETE
AS
	BEGIN
		UPDATE DETAI
		SET SOSV = (SELECT COUNT (DISTINCT MASV) FROM DIEMSV
					WHERE DIEMSV.MADT = DETAI.MADT)
	END 
