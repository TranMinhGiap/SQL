CREATE TABLE CHUYENDI
(
	MACD VARCHAR(10) PRIMARY KEY,
	TENCD VARCHAR(50),
	NGAYKH DATE,
	NGAYKT DATE,
	KHDK INT
)
GO 
CREATE TABLE DIADIEM
(
	MADD VARCHAR(10) PRIMARY KEY,
	TENDD VARCHAR(10),
	TP VARCHAR(10)
)
GO 
CREATE TABLE CTCD
(
	MACD VARCHAR(10),
	MADD VARCHAR(10),
	SNL INT,
	PRIMARY KEY (MACD,MADD),
	FOREIGN KEY (MACD) REFERENCES CHUYENDI(MACD),
	FOREIGN KEY (MADD) REFERENCES DIADIEM(MADD)
)

INSERT INTO CHUYENDI VALUES
('CD01','DULICH1','2023/08/09','2023/09/12',50),
('CD02','DULICH2','2023/01/10','2023/04/05',40),
('CD03','DULICH3','2023/02/12','2023/05/09',70),
('CD04','DULICH4','2023/03/22','2023/06/22',35),
('CD05','DULICH5','2023/04/27','2023/07/30',15),
('CD06','DULICH6','2023/05/30','2023/10/15',60)

INSERT INTO DIADIEM VALUES
('DD01','NUI1','HALONG'),
('DD02','NUI2','THAIBINH'),
('DD03','NUI3','HANOI'),
('DD04','NUI4','THANHHOA'),
('DD05','NUI5','HAI PHONG'),
('DD06','NUI6','QUANG NINH'),
('DD07','NUI7','SAI GON')

INSERT INTO CTCD VALUES
('CD01','DD01',1),
('CD01','DD03',2),
('CD01','DD05',3),
('CD02','DD02',4),
('CD02','DD04',5),
('CD03','DD07',6),
('CD03','DD06',7),
('CD04','DD02',8),
('CD04','DD06',9),
('CD05','DD07',10),
('CD05','DD03',11),
('CD05','DD05',12),
('CD06','DD01',13),
('CD06','DD03',14),
('CD06','DD05',15)

-- 2 HIEN THI CAC DIA DIEM DU LICH ( MADD , TENDD ) CUA CHUYEN DI CO MA CD02
SELECT DIADIEM.MADD,TENDD FROM DIADIEM,CHUYENDI,CTCD
WHERE DIADIEM.MADD = CTCD.MADD
AND CTCD.MACD = CHUYENDI.MACD
AND CHUYENDI.MACD = 'CD02'

-- 3 TAO VIEW HIEN THI THONG TIN CHUYEN DI VA SO LUONG DIA DIEM CUA CHUYEN DI DO
CREATE VIEW V_1 AS
SELECT CHUYENDI.MACD,TENCD,COUNT(*) AS SLCD
FROM DIADIEM,CHUYENDI,CTCD
WHERE DIADIEM.MADD = CTCD.MADD
AND CTCD.MACD = CHUYENDI.MACD
GROUP BY CHUYENDI.MACD,TENCD

SELECT * FROM V_1

-- 4 VIET TRIGGER THUC HIEN KIEM TRA NGAT KHOI HANH VA NGAY KET THUC KHI THEM HAY SUA
-- PHAI LON HON HOAC BANG NGAY HIEN TAI 
CREATE TRIGGER TG1 ON CHUYENDI
FOR INSERT
AS
	IF ((SELECT NGAYKH FROM inserted) < GETDATE() AND (SELECT NGAYKT FROM inserted) < GETDATE())
	BEGIN
		PRINT'NGAY KHOI HANH PHAI LON HON NGAY HIEN TAI'
		ROLLBACK TRAN 
	END
DROP TRIGGER TG1 
-- 5 HIEN THI SO NGAY LUU LON NHAT , NHO NHAT CUA CHUYEN DI CO MA CD01
SELECT MAX(SNL) AS MAXSND,MIN(SNL) AS MINSNL FROM CTCD
WHERE MACD = 'CD01'

SELECT * FROM CTCD
-- HOAC XAP XEP LAY TOP 1 CX DC NHUNG PHAI 2 LAN DO LA TANG DAN VA GIAM DAN 

-- 6 TAO VIEW HIEN THI THONG TIN CUA CAC CHUYEN DI BAO GOM MA,TEN CD , VA CO NGAY KH TRONG NAM 2020
SELECT * FROM CTCD,CHUYENDI
WHERE CHUYENDI.MACD = CTCD.MACD

CREATE VIEW V_2 AS
	SELECT CHUYENDI.MACD,TENCD
	FROM CTCD,CHUYENDI
	WHERE CHUYENDI.MACD = CTCD.MACD
	AND YEAR(NGAYKH) = '2023'

SELECT * FROM V_2

-- 7 TAO THU TUC HIEN THI THONG TIN CUA DIA DIEM KHI BIET MA DIA DIEM 
CREATE PROC PR_1 @CHECK VARCHAR(10) AS
SELECT * FROM DIADIEM
WHERE MADD = @CHECK

EXEC PR_1 'DD01' 

-- 8 HIEN THI MA CHUYEN DI ,MA DIA DIEM VA SO NGAY LUU VOI DIEU KIEN CO SO NGAY LUU LAI MAX 
SELECT CHUYENDI.MACD,DIADIEM.MADD,MAX(SNL) AS SONGAY FROM CHUYENDI,DIADIEM,CTCD
WHERE CTCD.MACD = CHUYENDI.MACD
AND CTCD.MADD = DIADIEM.MADD
GROUP BY CHUYENDI.MACD,DIADIEM.MADD
HAVING MAX(SNL) >= ALL(SELECT SNL FROM CTCD)

-- 9 TAO BO SUNG RANG BUOC DEFAULT CHO COT SNL BANG 0
SELECT * INTO CTCD_NEW FROM CTCD

ALTER TABLE CTCD_NEW ADD PRIMARY KEY (MACD,MADD)

CREATE DEFAULT DF_9 AS 0

EXEC sp_bindefault 'DF_9','CTCD_NEW.SNL'

-- 10 TAO THU TUC HIEN THI THONG TIN CUA CHUYEN DI KHI BIET MA CHUYEN DI 
CREATE PROC PR_10 @CHECK VARCHAR(10) AS
SELECT * FROM CHUYENDI
WHERE MACD = @CHECK

EXEC PR_10 'CD01'

-- 11 HIEN THI TT CUA CAC CHUYEN DI BAO GOM MA VA TEN CHUYEN DI VA CO NGAY KHOI HANH LA 2023-08-09
SELECT MACD,TENCD FROM CHUYENDI
WHERE NGAYKH = '2023/08/09'


-- 12 TAO BO SUNG RANG BUOC DEFAULT CHO COT NGAYKH BANG NGAY HIEN TAI
CREATE DEFAULT DF_12 AS GETDATE()
GO
EXEC sp_bindefault 'DF_12','CHUYENDI_NEW.NGAYKH'

-- 13 TAO TU TUC HIEN THI TEN CHUYEN DI VA SO LUONG DIA DIEM CUA CHUYEN DI KHI BIET MA CHUYEN DI 
CREATE PROC PR_13 @CHECK VARCHAR(10) AS
SELECT TENCD,COUNT(*) AS SOLUONGCD FROM CTCD,CHUYENDI
WHERE CTCD.MACD = CHUYENDI.MACD
AND CHUYENDI.MACD = @CHECK
GROUP BY TENCD

EXEC PR_13 'CD02'

-- 14 HIEN THI THONG TIN CUA CAC CHUYEN DI GOM CO MA VA TEN CHUYEN DI CO SO KHACH DU KIEN IT NHAT
SELECT MACD,TENCD FROM CHUYENDI
WHERE KHDK <= ALL(SELECT KHDK FROM CHUYENDI)  -- HOAC DUNG HAM MAX CX DUOC SELECT MAX

-- 15 VIET TRIGGER THUC HIEN KIEM TRA SO NGAY LUU TREN BANG CTCD KHI THAM HAY SUA PHAI THOA MAN SNL >= 1
CREATE TRIGGER TR_15 ON CTCD_NEW 
FOR UPDATE,INSERT
AS
	IF((SELECT SNL FROM inserted) < 1)
	BEGIN
		PRINT'SNL PHAI >= 1'
		ROLLBACK TRAN
	END

-- 16 HIEN THI THONG TIN CUA CAC DIA DIEM BAO GOM MA,TEN DIA DIEM THUOC THANH PHO HANOI
SELECT MADD,TENDD FROM DIADIEM
WHERE TP = 'HANOI'

-- 17 TAO BO SUNG RANG BUOC RULE CHO COT NGAYKH,NGAYKT >= NGAY HIEN TAI
SELECT * FROM CHUYENDI_NEW

CREATE RULE R_17 AS @CHECK >= GETDATE()

EXEC sp_bindrule 'R_17','CHUYENDI_NEW.NGAYKH'
GO
EXEC sp_bindrule 'R_17','CHUYENDI_NEW.NGAYKT'

-- 18 VIET TRIGGER THUC HIEN KIEM TRA SO KHACH DKI TREN BANG CHUYEN DI KHI THEM HAY SUA PHAI THOA MAN KHDK >= 1
SELECT * FROM CHUYENDI_NEW

CREATE TRIGGER TR_18 ON CHUYENDI_NEW
FOR UPDATE,INSERT
AS
	IF((SELECT KHDK FROM inserted) < 1 )
	BEGIN
		PRINT'KHDK PHAI >= 1'
		ROLLBACK TRAN
	END

-- 19 BACKUP		





