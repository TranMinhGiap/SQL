CREATE TABLE GIANGVIEN
(
	GV VARCHAR(10) PRIMARY KEY,
	HOTEN VARCHAR(30),
	DIACHI VARCHAR(10),
	NGAYSINH DATE
)
GO
CREATE TABLE DETAI
(
	DT VARCHAR(10) PRIMARY KEY,
	TENDT VARCHAR(30),
	CAP VARCHAR(10),
	KINHPHI FLOAT
)
GO
CREATE TABLE THAMGIA
(
	GV VARCHAR(10),
	DT VARCHAR(10),
	SOGIO INT,
	PRIMARY KEY (GV,DT),
	FOREIGN KEY (GV) REFERENCES GIANGVIEN(GV),
	FOREIGN KEY (DT) REFERENCES DETAI(DT)
)

INSERT INTO GIANGVIEN VALUES
('GV01','NGUYEN HONG KHANH','MY DINH','1982/10/10'),
('GV02','PHUONG VAN CANH','NAM TL','1986/11/03'),
('GV03','PHAM QUANG HUY','DONG DA','1990/06/04'),
('GV04','NGO HOANG HUY','TAY HO','1993/12/10'),
('GV05','LE TRANG LINH','CAU GIAY','1986/10/10')

INSERT INTO DETAI VALUES
('DT01','PHAT HIEN TRI THUC','NHA NUOC',700),
('DT02','TINH TOAN LUOI','BO',300),
('DT03','AN TOAN THONG TIN','BO',270),
('DT04','NHAN DANG KHUAN MAT EPU FACE','TRUONG',30)

INSERT INTO THAMGIA VALUES
('GV01','DT01',100),
('GV01','DT02',80),
('GV01','DT03',80),
('GV02','DT01',120),
('GV02','DT03',140),
('GV03','DT03',150),
('GV04','DT04',180)

-- 2 DUA RA THONG TIN GIANG VIEN CO DIA CHI CAU GIAY XAP XEP THEO THU TU GIAM DAN THEO TEN
SELECT * FROM GIANGVIEN
WHERE DIACHI = 'CAU GIAY'
ORDER BY HOTEN DESC

-- 3 TAO VIEW HIEN THI TEN DE TAI KINH PHI VA CHI LIET KE NHUNG DE TAI CO KINH PHI > 270
CREATE VIEW V_2 AS
SELECT * FROM DETAI
WHERE KINHPHI > 270

SELECT * FROM V_2

-- 4 DUA RA DANH SACH GOM TEN DIA CHI NGAY SINH CUA GIANG VIEN CO THAM GIA VAO DE TAI " TINH TOAN LUOI "
SELECT HOTEN,DIACHI,NGAYSINH FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT
AND TENDT = 'TINH TOAN LUOI'

-- 5 TAO THU TUC HIEN THI TEN DE TAI CUA NHUNG DE TAI CO KINH PHI MAX 
CREATE PROC PR_5 AS
SELECT TENDT FROM DETAI
WHERE KINHPHI = (SELECT MAX(KINHPHI) FROM DETAI)

EXEC PR_5

-- 6 THEM THONG TIN GIANG VIEN NGUYEN VAN HIEU 08/09/1995 DONG DA HA NOI 
INSERT INTO GIANGVIEN VALUES
('GV06','NGUYEN VAN HIEU','DONG DA','1995/09/08')

UPDATE GIANGVIEN 
SET HOTEN = 'NGUYEN VAN HIEU',DIACHI = 'DONG DA',NGAYSINH = '1995/09/08'
WHERE GV = 'GV06'

-- 7 DDUA RA DANH SACH GOM HO TEN DIA CHI NGAY SINH CUA GIANG VIEN CO THAM GIA VAO DE TAI PHAT TRIEN TRI THUC
-- HOAC 'NHAN DANG KHUAN MAT EPUFACE'
SELECT HOTEN,DIACHI,NGAYSINH FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT
AND TENDT IN ('PHAT HIEN TRI THUC','NHAN DANG KHUAN MAT EPU FACE')

-- 8 GIANG VIEN NGUYEN HONG KHANH MOI CHUYEN VE QUAN CAU GIAY HAY CAP NHAT THONG TIN NAY 
UPDATE GIANGVIEN
SET DIACHI = 'CAU GIAY'
WHERE HOTEN = 'NGUYEN HONG KHANH'

-- 9 CHO BIET THONG TIN CUA GIANG VIEN THAM GIA IT NHAT 2 DE TAI 
SELECT GIANGVIEN.GV,HOTEN,COUNT(*) AS SOLUONG FROM GIANGVIEN,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
GROUP BY GIANGVIEN.GV,HOTEN
HAVING COUNT(*) >= 2

-- 10 DUA RA MA GV , TEN GV VA TONG SO GIO THAM GIA NGHIEN CUU KHOA HOC CUA TUNG GIANG VIEN 
SELECT GIANGVIEN.GV,HOTEN,SUM(SOGIO) AS TOTAL
FROM GIANGVIEN,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
GROUP BY GIANGVIEN.GV,HOTEN

-- 11 CHO BIET TEN GIANG VIEN THAM GIA NHIEU DE TAI NHAT 
SELECT HOTEN FROM GIANGVIEN,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
GROUP BY HOTEN
HAVING COUNT(*) >= ALL(SELECT COUNT(*) FROM GIANGVIEN,THAMGIA
						WHERE GIANGVIEN.GV = THAMGIA.GV
						GROUP BY HOTEN)
-- HOAC DUNG MAX 

-- 12 DUNG VIEW DE LIET KE NHUNG DE TAI CAP BO
CREATE VIEW V_12 AS
SELECT DT,TENDT FROM DETAI
WHERE CAP = 'BO'

SELECT * FROM V_12

-- 13 CHO BIET TEN NHUNG GIANG VIEN SINH TRUOC NAM 1989 VA CO THAM GIA DE TAI AN TOAN THONG TIN 
SELECT * FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT
AND YEAR(NGAYSINH) < 1989 
AND TENDT = 'AN TOAN THONG TIN'

-- 14 HIEN THI TEN DE TAI TON IT KINH PHI NHAT
SELECT DT,TENDT FROM DETAI
WHERE KINHPHI <= ALL(SELECT KINHPHI FROM DETAI)  -- HOAC DUNG MAX MIN

-- 15 CHO BIET TEN VA NGAY SINH CUA GIANG VIEN SONG O QUAN TAY HO VA TEN CAC DE TAI MA GV NAY THAM GIA 
SELECT HOTEN,DAY(NGAYSINH) AS NGAYSINH,TENDT
FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT
AND DIACHI = 'TAY HO'

-- 16 TAO VIEW DE HIEN THI THONG TIN CUA DE TAI VA GIANG VIEN THUC HIEN
CREATE VIEW V_16 AS
SELECT DETAI.DT,TENDT,CAP,KINHPHI,GIANGVIEN.GV,HOTEN
FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT

SELECT * FROM V_16

-- 17 HIEN THI TEN DE TAI CO KINH PHI MAX 
SELECT DT,TENDT FROM DETAI
WHERE KINHPHI = (SELECT MIN(KINHPHI) FROM DETAI)

-- 18 DUA RA TOAN BO THONG TIN MA DT TEN DT VA GIANG VIEN THAM GIA  
SELECT *FROM GIANGVIEN,DETAI,THAMGIA
WHERE GIANGVIEN.GV = THAMGIA.GV
AND DETAI.DT = THAMGIA.DT

-- 19 DUA RA THONG TIN CUA DE TAI CO KINH PHI LON NHAT
SELECT DT,TENDT FROM DETAI
WHERE KINHPHI = (SELECT MAX(KINHPHI) FROM DETAI)

-- 20 HAY THEM COT THANH TIEN CHO BANG THAM GIA
ALTER TABLE THAMGIA 
ADD THANHTIEN FLOAT

-- 21 VIET TRIGGER CAP NHAT THANH TIEN CHO BANG THAM GIA BIET THANH TIEN = SO GIO * 50000
CREATE TRIGGER TG_21 ON THAMGIA
FOR INSERT
AS
	BEGIN
		UPDATE THAMGIA 
		SET THAMGIA.THANHTIEN = inserted.SOGIO * 50000
		FROM inserted,THAMGIA
		WHERE THAMGIA.GV = inserted.GV
		AND THAMGIA.DT = inserted.DT
	END

	DROP TRIGGER TG_21

-- 22 
BACKUP DATABASE BAI6_DC TO DISK = 'E:/BACKUP.bak'
