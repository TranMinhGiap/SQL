CREATE TABLE DIADIEM
(
	MADD VARCHAR(10) PRIMARY KEY,
	TENDD VARCHAR(30),
	THANHPHO VARCHAR(30)
)
GO
CREATE TABLE CHUYENDI
(
	MACD VARCHAR(10) PRIMARY KEY,
	TENCD VARCHAR(30),
	NGAYKH DATE,
	NGAYKT DATE,
	SOKHACHDUKIEN INT,
)
GO
CREATE TABLE CHITIETCD
(
	MACD VARCHAR(10),
	MADD VARCHAR(10),
	SONGAYLUU INT,
	PRIMARY KEY (MACD,MADD),
	FOREIGN KEY (MACD) REFERENCES CHUYENDI(MACD),
	FOREIGN KEY (MADD) REFERENCES DIADIEM(MADD)
)

INSERT INTO DIADIEM VALUES
('DD01','VAN MIEU QUOC TU GIAM','HA NOI'),
('DD02','THAP BAC SAPA','SAPA'),
('DD03','PHO CO HA NOI','HA NOI'),
('DD04','CO HOA LU','NINH BINH'),
('DD05','PHONG NHA KE BANG','HA LONG'),
('DD06','TAM COC - BICH DONG','NINH BINH'),
('DD07','SUN WORLD BA NA HILLS','DA NANG')

INSERT INTO CHUYENDI VALUES
('CD01','CHUYEN DI 1','2022/11/07','2022/12/15',60),
('CD02','CHUYEN DI 2','2022/08/17','2022/05/21',60),
('CD03','CHUYEN DI 3','2022/01/12','2022/02/25',60),
('CD04','CHUYEN DI 4','2022/06/02','2023/07/11',60),
('CD05','CHUYEN DI 5','2023/11/28','2023/12/05',60),
('CD06','CHUYEN DI 6','2022/03/12','2022/05/14',60),
('CD07','CHUYEN DI 7','2022/06/29','2022/08/21',60),
('CD08','CHUYEN DI 8','2022/12/18','2022/12/26',60),
('CD09','CHUYEN DI 9','2022/04/24','2022/07/10',60)

INSERT INTO CHITIETCD VALUES
('CD01','DD01',25),
('CD01','DD03',25),
('CD01','DD05',25),
('CD02','DD02',25),
('CD02','DD04',25),
('CD03','DD07',25),
('CD03','DD05',25),
('CD03','DD06',25),
('CD04','DD02',25),
('CD05','DD03',25),
('CD05','DD01',25),
('CD06','DD03',25),
('CD06','DD07',25),
('CD07','DD05',25),
('CD08','DD03',25),
('CD09','DD02',25),
('CD09','DD07',25)

-- 2 ) TAO VIEW LUU THONG TIN CHUYEN DI DI QUA NHIEU DIA DIEM NHAT
CREATE VIEW V1 AS
SELECT MACD,COUNT(*) AS SOLUONGCD 
FROM CHITIETCD
GROUP BY MACD
HAVING COUNT(*) >= ALL(SELECT COUNT(*) AS SOLUONGCD
						FROM CHITIETCD
						GROUP BY MACD)
-- NEU SELECT TOP 1 TRONG TRUONG HOP CO NHIEU CHUYEN DI BANG NHAU NHU NAY SE BI THIEU THONG TIN !
SELECT * FROM V1

-- 3 ) TAO RULE CHO COT NGAY KHOI HANH PHAI LON HON NGAY HIEN TAI
CREATE RULE R1 AS @CHECK >= GETDATE()
GO 
EXEC sp_bindrule 'R1','CHUYENDI.NGAYKH'

-- 4 ) TAO THU TUC HIEN THI CAC THONG TIN CHUYEN DI DA DI QUA THANH PHO HA NOI
CREATE PROC PR1 AS 
SELECT DISTINCT CD.MACD,TENCD FROM CHUYENDI CD,CHITIETCD CT,DIADIEM DD
WHERE CD.MACD = CT.MACD
AND CT.MADD = DD.MADD
AND THANHPHO = 'HA NOI'

EXEC PR1

-- 5 ) TAO TRIGGER KIEM TRA SO NGAY LUU LAI QUA MOI DIA DIEM KHI SUA DU LIEU TRONG BANG CHITIETCD 
-- PHAI LON HON 0 NGUOC LAI HAY DUA RA THONG BAO !
CREATE TRIGGER TG1 ON CHITIETCD
FOR UPDATE
AS
	BEGIN
		IF((SELECT SONGAYLUU FROM inserted) < 0)
		BEGIN
			PRINT'SO NGAY LUU PHAI >= 0'
			ROLLBACK TRAN
		END
	END

-- 6 ) BACKUP DU LIEU
