CREATE TABLE SACH
(
	MASACH VARCHAR(10) PRIMARY KEY,
	TENSACH VARCHAR(30),
	NXB VARCHAR(30),
	NAMXB INT,
	THELOAI VARCHAR(30),
	SOLUONG INT,
)
GO
CREATE TABLE DOCGIA
(
	MADG VARCHAR(10) PRIMARY KEY,
	TENDG VARCHAR(30),
	DT VARCHAR(10),
	DIACHI VARCHAR(10)
)
GO
CREATE TABLE PHIEUMUON
(
	MAPM VARCHAR(10) PRIMARY KEY,
	MADG VARCHAR(10) REFERENCES DOCGIA(MADG),
	NGAYMUON DATE
)
GO
CREATE TABLE CTPHIEUMUON
(
	MAPM VARCHAR(10),
	MASACH VARCHAR(10),
	SOLUONG INT,
	NGAYTRA DATE,
	PRIMARY KEY (MAPM,MASACH),
	FOREIGN KEY (MAPM) REFERENCES PHIEUMUON(MAPM),
	FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
)

INSERT INTO SACH VALUES
('S01','DAC NHAN TAM','Dale Carnegie',1969,'mieu ta',10),
('S02','NHA GIA KIM','Paulo Coelho',1945,'tieu thuyet',11),
('S03','TUOI TRE DANG GIA BAO NHIEU','Rosie nguyen',1975,'truyen ngan',12),
('S04','ONG GIA VA BIEN CA',' Hemingway',1954,'ky',13),
('S05','NHUNG TAM LONG CAO CA','Edmondo De Amicis',1989,'mieu ta',14),
('S06','CHO TOI XIN 1 VE DI TUOI THO','Nguyen Nhat anh',1989,'tu su',15)

INSERT INTO DOCGIA VALUES
('DG01','DANG YEN NHI','0386428423','HA NOI'),
('DG02','TRAN MINH GIAP','0396434223','THAI BINH'),
('DG03','NGUYEN THI BINH','0393101525','HA LONG'),
('DG04','TRAN VAN BINH','0394530944','THAI BINH'),
('DG05','NGUYEN QUANG HUY','043568975','HAI PHONG'),
('DG06','PHAM THI THUY','0296434222','THANH HOA'),
('DG07','VU LAI NGOC TRINH','043122398','SAI GON'),
('DG08','PHAM HONG NGA','045923766','JAPAN'),
('DG09','TRAN MIINH CHUNG','0391997333','THAI BINH')

INSERT INTO PHIEUMUON VALUES
('PM01','DG01','2023/09/15'),
('PM02','DG01','2023/07/05'),
('PM03','DG02','2023/10/19'),
('PM04','DG03','2023/11/20'),
('PM05','DG04','2023/03/03'),
('PM06','DG05','2023/12/25'),
('PM07','DG06','2023/09/10'),
('PM08','DG07','2023/02/01')

INSERT INTO CTPHIEUMUON VALUES
('PM01','S02',5,'2023/10/15'),
('PM02','S01',5,'2023/08/05'),
('PM03','S03',5,'2023/12/15'),
('PM04','S04',5,'2024/10/15'),
('PM05','S02',5,'2023/11/15'),
('PM06','S06',5,'2023/12/15'),
('PM07','S03',5,'2023/07/15'),
('PM08','S04',5,'2023/03/15')

-- 1 ) HIEN THI TEN SACH MA MA DOC GIA CO MA DG01 MUON TRONG NGAY 
SELECT * FROM CTPHIEUMUON,SACH,PHIEUMUON
WHERE CTPHIEUMUON.MAPM = PHIEUMUON.MAPM
AND CTPHIEUMUON.MASACH = SACH.MASACH
AND MADG = 'DG01'
AND NGAYMUON = '2023/09/15'

-- 2 ) TAO DEFAULT CHO COT NGAY MUON LA NGAY HIEN TAI
CREATE DEFAULT DF1 AS GETDATE()
GO
EXEC sp_bindefault 'DF1','PHIEUMUON.NGAYMUON'

EXEC sp_bindefault 'PHIEUMUON.NGAYMUON'  -- XOA RANG BUOC

DROP DEFAULT DF1  -- XOA DEFAULT 

-- 3 ) TAO THU TUC HIEN THI THONG TIN CUA SACH KHI BIET MA PHIEU MUON 
CREATE PROC PR1 @CHECK VARCHAR(10) AS
SELECT SACH.MASACH,TENSACH,NXB,THELOAI FROM CTPHIEUMUON,SACH
WHERE  CTPHIEUMUON.MASACH = SACH.MASACH
AND MAPM = @CHECK

EXEC PR1 'PM05'

SELECT * FROM CTPHIEUMUON,SACH
WHERE CTPHIEUMUON.MASACH = SACH.MASACH

DROP PROC PR1  -- XOA THU TUC

-- 4 ) TAO TRIGGER CAP NHAT LAI SO SACH TRONG THU VIEN KHI SO LUONG SACH TRONG CTPHIEUMUON THAY DOI
CREATE TRIGGER TG1 ON CTPHIEUMUON
AFTER UPDATE
AS
	BEGIN
		UPDATE SACH
		SET SOLUONG = SACH.SOLUONG + D.SOLUONG - I.SOLUONG
		FROM inserted I,deleted D
		WHERE SACH.MASACH = I.MASACH
		AND SACH.MASACH = D.MASACH
	END



